<!DOCTYPE html>

<style type="text/css">

body {
	font-family: Arial, Helvetica, sans-serif; 
	background-color: white
}

td {
	border-radius: 12px;
	font-size: 12px;
}

h2 {
	display: inline;
}

/* All content are in center div */
.center {
  margin: 0;
  position: absolute;
  top: 50%;
  left: 50%;
  -ms-transform: translate(-50%, -50%);
  transform: translate(-50%, -50%);
  width: 300px; 
}

/* Button formatting */
.dropbtn {
  background-color: white;
  color: black;
  padding: 14px;
  font-size: 16px;
  border: none;
  cursor: pointer;
  border-radius: 12px;
  display: inline-block;
}

.dropbtn:hover, .dropbtn:focus {
  background-color: #96BAF0;
}

.dropdown {
  position: relative;
  display: inline;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f1f1f1;
  min-width: 160px;
  overflow: auto;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  font-size: 12px;
}

.dropdown a:hover {
	background-color: #ddd;
}

/* Visibility */
.show {
	display: block;
}

.hidden { 
	font-size: 0; 
}

</style>

<html> <!-- ! Important for mobile view -->

<meta name="viewport" content="width=device-width, initial-scale=1">

<head><title>show.me recommendations</title></head>

<body>

	<!-- start center div -->
	<div class="center"> 
	<h2>show.me</h2> &nbsp; 

	<!-- dropdown menus -->
	<div class="dropdown">
	<button onclick="myFunction()" class="dropbtn">&#9776</button>
		<div id="myDropdown" class="dropdown-content">
			<a href="/recs">Recommendations</a>
			<a href="/likes">My Liked Titles</a>
			<a href="/dislikes">My Disliked Titles</a>
			<a href="/saves">My Saved Titles</a>
		</div>

		<div class="dropdown">
			<button onclick="myFunction1()" class="dropbtn">&#10754</button>
			<div id="myDropdown1" class="dropdown-content">
			<a href="/">Log out</a>
			</div>
		</div>

	<p><b>logged in as: </b></p> <p id="printName"></p>

	<script>
	document.getElementById("printName").innerHTML = window.localStorage.getItem('currentUser');
	</script>

	<p>Use arrows or swipe. Right to like, left to discard, down to save, up to skip.</p>

	<!-- title table -->
	<table class="some_style" align="center" border="0" bordercolor="#ccc" cellpadding="5" cellspacing="0" style="border-collapse:collapse;" id="help">
	<tbody>
		<tr>
			<td style="text-align: center;">&nbsp;</td>
			<td style="text-align: center; height: 35">&nbsp;</td>
			<td style="text-align: center;">&nbsp;</td>
		</tr>
		<tr>
			<td style="text-align: center; width: 35">&nbsp;</td>
			<td style="width: 500px; height: 80px;">
			<h2 style="text-align: center;"><q><span style="font-size:22px;"><span style="font-family:arial,helvetica,sans-serif;">&nbsp;</span></span></q></h2></td>
			<td style="text-align: center; width: 35">&nbsp;</td>
		</tr>
		<tr>
			<td style="text-align: center;">&nbsp;</td>
			<td style="text-align: center; height: 35">&nbsp;</td>
			<td style="text-align: center;">&nbsp;</td>
		</tr>
	</tbody>
	</table>

	</div>  
	<!-- ends center div -->

	<!-- hidden information -->
	<div class="hidden" id="titleInfo">EMPTY</div> 
	<p>&nbsp;</p>

</body>

</html>

<script src="https://www.gstatic.com/firebasejs/5.10.0/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/5.10.0/firebase-firestore.js"></script>

<script>

nextTitle("skip"); // when window first loads

// Keyboard listener
window.addEventListener("keyup", dealWithKeyboard, true);
function dealWithKeyboard(e) {
	// Key press
	var x = document.getElementById("help").getElementsByTagName("td");
	if (e.keyCode == 37) { 
		// alert("Left"); 
		displayAction(3, "dislike")
		nextTitle("dislike")     
	}
	else if (e.keyCode == 38) { 
		// alert("Up"); 
		displayAction(1, "skip")
		nextTitle("skip")     
    }
	else if (e.keyCode == 39) { 
		// alert("Right"); 
		displayAction(5, "like")
		nextTitle("like")     
	}
	else if (e.keyCode == 40) { 
		// alert("Down"); 
		displayAction(7, "save");
		nextTitle("save")     
	}
	else if (e.keyCode == 32)
	{
		var info = document.getElementById("titleInfo")
		alert(info.innerHTML)
	}
}

function displayAction(index, action) {
	// Prints action name in corresponding cell for 800ms
    var x = document.getElementById("help").getElementsByTagName("td");
    setTimeout(function() { 
    	x[index].style.backgroundColor = "white"; 
    	x[index].innerHTML = "";
	}, 800);
    x[index].innerHTML = action;
}

/* Toggle menu and logout menu buttons */
function myFunction() {
  document.getElementById("myDropdown").classList.toggle("show");
}
function myFunction1() {
  document.getElementById("myDropdown1").classList.toggle("show");
}

// Close the dropdown if the user clicks outside of it
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {
    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}

function getRandomArbitrary(min, max) {
    return Math.floor(Math.random() * (max - min) + min);
}

function nextTitle(action) {
	// Formatting for title string
    const str1 = '<h2 style="text-align: center;"><q><span style="font-size:22px;"><span style="font-family:arial,helvetica,sans-serif;">'; 
    const str3 = '</span></span></q></h2>';

    // Get recs from rec list 
    var trainData = getRecsFromFile()
    var sortedList = knn(trainData.join("\n"));
    var titleInfo = ""
    if (sortedList.length == 0 || action != "like")
    {
    	alert("Get recs from file")
	    // Get recs from file
	    var recs = getRecsFromFile()
		var i = getRandomArbitrary(0, recs.length)
		titleInfo = recs[i].split("@")
		var titleGenres = titleInfo[1].trim().split(",") 
		var titleRating = titleInfo[2]
	}
	else
	{
		alert("Get recs from first 0.5% of sortedList: ".concat(sortedList))
		// Pick from start of sorted list
		var i = getRandomArbitrary(0, Math.floor(sortedList.length*0.005));
		titleInfo = sortedList[i].split("@")
	}

	// Update screen
	updateTitle(titleInfo)
}

// Takes titleList[i].split("@")
// called every time an action is performed
function updateTitle(titleInfo) {
	// Formatting for title string
    const str1 = '<h2 style="text-align: center;"><q><span style="font-size:22px;"><span style="font-family:arial,helvetica,sans-serif;">'; 
    const str3 = '</span></span></q></h2>';

    // Parse titleInfo
    var title = titleInfo[0]
    var genres = titleInfo[1]
    var rating = titleInfo[2]

    // Update title on screen
    var x = document.getElementById("help").getElementsByTagName("td");
    x[4].innerHTML = str1.concat(title, str3);
    // Updates hidden titleInfo
    var y = document.getElementById("titleInfo");
    var str = title.concat("@", genres, "@", rating)
    y.innerHTML = str;

    alert(document.getElementById("titleInfo").innerHTML)
}

function getRecsFromFile() {
	// Returns list of movie titleInfo strings
	var recs = [];
	// Request file from server
	var client = new XMLHttpRequest();
	client.open('GET', 'titles.txt', false);
	client.onreadystatechange = function() {
		var response = client.responseText;
		var titles = response.split("\n")
		for (var i = 0; i < titles.length; i++) {
			recs.push(titles[i])
		}
	}
	client.send();
	return recs
}

// Swipe
// credit: http://www.javascriptkit.com/javatutors/touchevents2.shtml
function swipedetect(el, callback){
  
    var touchsurface = el,
    swipedir,
    startX,
    startY,
    distX,
    distY,
    threshold = 150, //required min distance traveled to be considered swipe
    restraint = 100, // maximum distance allowed at the same time in perpendicular direction
    allowedTime = 300, // maximum time allowed to travel that distance
    elapsedTime,
    startTime,
    handleswipe = callback || function(swipedir){}
  
    touchsurface.addEventListener('touchstart', function(e){
        var touchobj = e.changedTouches[0]
        swipedir = 'none'
        dist = 0
        startX = touchobj.pageX
        startY = touchobj.pageY
        startTime = new Date().getTime() // record time when finger first makes contact with surface
        e.preventDefault()
    }, false)
  
    touchsurface.addEventListener('touchmove', function(e){
        e.preventDefault() // prevent scrolling when inside DIV
    }, false)
  
    touchsurface.addEventListener('touchend', function(e){
        var touchobj = e.changedTouches[0]
        distX = touchobj.pageX - startX // get horizontal dist traveled by finger while in contact with surface
        distY = touchobj.pageY - startY // get vertical dist traveled by finger while in contact with surface
        elapsedTime = new Date().getTime() - startTime // get time elapsed
        if (elapsedTime <= allowedTime){ // first condition for awipe met
            if (Math.abs(distX) >= threshold && Math.abs(distY) <= restraint){ // 2nd condition for horizontal swipe met
                swipedir = (distX < 0)? 'left' : 'right' // if dist traveled is negative, it indicates left swipe
            }
            else if (Math.abs(distY) >= threshold && Math.abs(distX) <= restraint){ // 2nd condition for vertical swipe met
                swipedir = (distY < 0)? 'up' : 'down' // if dist traveled is negative, it indicates up swipe
            }
        }
        handleswipe(swipedir)
        e.preventDefault()
    }, false)
}
  
//USAGE
// Did make changes and write body of function 
var el = document.getElementById('help');
swipedetect(el, function(swipedir){
    // swipedir contains either "none", "left", "right", "top", or "down"
    var x = document.getElementById("help").getElementsByTagName("td");
	if (swipedir == "left") { 
		displayAction(3, "dislike")
		nextTitle("dislike")     
	}
	else if (swipedir == "up") { 
		displayAction(1, "skip")
		nextTitle("skip")     
    }
	else if (swipedir == "right") { 
		displayAction(5, "like")
		nextTitle("like")     
	}
	else if (swipedir == "down") { 
		displayAction(7, "save")
		nextTitle("save")     
	}
});

</script>


<script type="text/javascript">

// Retrieves username's lists from database
// function getUserLists(username) {
// 	// Initialize Firebase
// 	var config = {
// 		apiKey: "AIzaSyAYAf35t-8bGqp-6WsRtSM-sqJqp5z9P_w",
// 		authDomain: "showme-22fa9.firebaseapp.com",
// 		databaseURL: "https://showme-22fa9.firebaseio.com",
// 		projectId: "showme-22fa9",
// 		storageBucket: "showme-22fa9.appspot.com",
// 		messagingSenderId: "336455638979"
// 	};
// 	firebase.initializeApp(config);
// 	var firestore = firebase.firestore();

// 	// Get user data
// 	const docRef = firestore.doc('users/' + username);

// 	// Retrieve likes, dislikes, saves, recs
// 	var lists = ["", "", "", ""];
// 	docRef.get().then(function(doc) {
// 		if(doc.exists) {
// 			const myData = doc.data();
// 			lists[0] = myData.likes
// 			lists[1] = myData.dislikes
// 			lists[2] = myData.saves
// 			lists[3] = myData.recs
// 		}
// 	});
// 	return lists;
// }

// // Updates username's lists to database
// function updateUserLists(username, likes, dislikes, saves, recs) {
// 	// Initialize Firebase
// 	var config = {
// 		apiKey: "AIzaSyAYAf35t-8bGqp-6WsRtSM-sqJqp5z9P_w",
// 		authDomain: "showme-22fa9.firebaseapp.com",
// 		databaseURL: "https://showme-22fa9.firebaseio.com",
// 		projectId: "showme-22fa9",
// 		storageBucket: "showme-22fa9.appspot.com",
// 		messagingSenderId: "336455638979"
// 	};
// 	firebase.initializeApp(config);
// 	var firestore = firebase.firestore();

// 	// Get user data
// 	const docRef = firestore.doc('users/' + username);

// 	// Update likes, dislikes, saves, recs
// 	var lists = ["", "", "", ""];
// 	docRef.get().then(function(doc) {
// 		if(doc.exists) {
// 			const myData = doc.data();
// 			if (likes != "") 
// 				docRef.set({ likes: myData.likes+likes }); 
// 			if (dislikes != "") 
// 				docRef.set({ likes: myData.dislikes+dislikes }); 
// 			if (saves != "") 
// 				docRef.set({ likes: myData.saves+saves }); 
// 			if (recs != "") {
// 				docRef.set({ likes: myData.recs+recs }); 
// 			}
// 		}
// 	});
// 	return lists;
// }


// Learning methods
function knn(trainData) {

	var titleInfo = document.getElementById("titleInfo").innerHTML.trim()
	// alert("KNN: ".concat(titleInfo))
	var smartRecs = []
	if (typeof(trainData) == typeof(titleInfo) && titleInfo != "EMPTY") {
		var trainInfo = trainData.split("\n")
		// Build recommendations based in titleInfo
		var scores = []
		for (var i = 0; i < trainInfo.length; i++)
		{
			var x = titleInfo.trim().split("@")
			var y = trainInfo[i].trim().split("@")
			
			var d = distance(x[0].toLowerCase(), y[0].toLowerCase(), " ")
			var d1 = distance(x[1].toLowerCase(), y[1].toLowerCase(), ",")
			if (x[2] != 0)
			{
				// weight by rating
				d = d*parseFloat(y[2]) 
				d1 = d1*parseFloat(y[2])
			}
			var score = d + d1 // max theoretical value is 20
			// alert(titleInfo.concat("\n", trainInfo[i], "\nSCORE=", score))
			if (x[0] != y[0])
				insertSort(smartRecs, scores, trainInfo[i], score)
			// alert(smartRecs)
		}
		// alert(smartRecs)
	}
	// updateUserLists(username, likes, dislikes, saves, recs)
	return smartRecs
}

// Sorted insertion in asecnding order by score
function insertSort(smartRecs, scores, newTitle, newScore) {
	// If list is empty
	if (smartRecs.length == 0) {
		smartRecs.push(newTitle)
		scores.push(newScore)
		return [smartRecs, scores]
	}
	// General case
	for (var i = 0; i < smartRecs.length; i++) {
		if (newScore >= scores[i]) {
			smartRecs.splice(i, 0, newTitle)
			scores.splice(i, 0, newScore)
			return [smartRecs, scores]
		}
	}
	// If smallest
	smartRecs.push(newTitle)
	scores.push(newScore)
	return [smartRecs, scores]
}

// Compute Jaccard index of two strings
function distance(x, y, delim) {
	var xlist = x.trim().split(delim)
	var ylist = y.trim().split(delim)
	
	var num = intersection(xlist, ylist)
	var total = xlist.length + ylist.length
	
	var index = num / total
	// alert("Index:".concat(index))

	return index
}

// Find # intersection between two arrays of words 
function intersection(list1, list2) {
	var longerList = list1
	var shorterList = list2
	if (list2.length > list1.length) {
		longerList = list2
		shorterList = list1
	}
	var numIntersections = 0
	for (var i = 0; i < longerList.length; i++)
	{
		var str1 = longerList[i]
		var isIntersection = 0
		for (var j = 0; j < shorterList.length; j++)
		{
			var str2 = shorterList[j]
			if (str1 == str2) 
				isIntersection = 1
			// alert("COMPARING-".concat(str1, "-AND-", str2, "-INT-", isIntersection))
		}
		numIntersections += isIntersection
	}
	// alert("end of intersection")
	return numIntersections
}

</script>


